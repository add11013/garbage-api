# Authress Login SDK for UIs
The Authress Universal Login SDK for javascript app websites and user identity authentication. Used to integrate with the authentication as a service provider Authress at https://authress.io.


[![npm version](https://badge.fury.io/js/authress-login.svg)](https://badge.fury.io/js/authress-login)


## Usage

```sh
npm install authress-login
```

Then required the package:
```js
const { LoginClient } = require('authress-login');
```

### Troubleshooting usage
Troubles with esbuild or another bundler, checkout the [build tools troubleshooting page](./docs/troubleshooting.md).

## Getting Started

### Part 0: Setup Authress Login
You'll want to create:
* at least one provider connection - https://authress.io/app/#/manage?focus=connections
* an application which represents your web app - https://authress.io/app/#/manage?focus=applications

### Part 1: Web App UI

On every route change check to see if the user exists, and if they don't redirect them to a login prompt.
```js
const { LoginClient } = require('authress-login');

// What is my applicationId => https://authress.io/app/#/manage?focus=applications
// What is my authressLoginHostUrl? => https://authress.io/app/#/setup?focus=domain
const loginClient = new LoginClient({ authressLoginHostUrl: 'https://login.application.com', applicationId: 'YOUR_APPLICATION_ID' });
const isUserLoggedIn = await loginClient.userSessionExists();
if (!isUserLoggedIn) {
  window.location.assign('/login');
}
```
In your app's login screen when the user selects how they would like to login, direct them there. And also specify where you would like Authress to redirect the user to after login. By default this is the user's current location.
```js
await loginClient.authenticate({ connectionId: 'SELECTED_CONNECTION_ID', redirectUrl: window.location.href });
// Or if you know which tenant the user wants to log in with:
await loginClient.authenticate({ tenantLookupIdentifier: 'tenant-subdomain.app.com', redirectUrl: window.location.href });
return;
```

Then get the user access token associated with the user's login to be used for authorization in the next part:
```js
const userToken = await loginClient.ensureToken();
```

### Part 2: User Authentication in Service APIs
To authenticate the user in your service API, the token generated by the library in `Part 1` needs to be passed to your service. The standard is pulling it from the loginClient, and putting it into an `Authorization` header:
```js
const userToken = await loginClient.ensureToken();
const result = await fetch('https://api.application.com/v1/route', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${userToken}`
  }
})
```

On the service API side, pull in the Authress service client companion library, and then verify the access token.

* First install the companion library: `npm install authress-sdk`
* Then verify the incoming tokens from the Authorization header:

```js
const { TokenVerifier } = require('authress-sdk');

try {
  // Grab authorization token from the request header, the best way to do this will be framework specific.
  const userToken = request.headers['Authorization'];
  // Specify your custom domain for tokens. Configurable at https://authress.io/app/#/manage?focus=applications
  const userIdentity = await TokenVerifier('https://login.application.com', userToken);
} catch (error) {
  console.log('User is unauthorized', error);
  return { statusCode: 401 };
}
```

## Advanced
Curious exactly how these methods work and when they should be used? We have some advanced guidance available for each of the methods on the [method documentation](./docs/advanced.md).

## Contributing

### Validating index.d.ts type definitions
For validation it helps to generate and compare the types to the generated files using:
```sh
npx typescript index.js --declaration --allowJs --emitDeclarationOnly --outDir types
```
